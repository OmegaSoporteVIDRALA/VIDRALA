name: Validate Salesforce PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3
        
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

     # - name: âœ’ï¸ Determine target branch
       # id: check_branch
       # run: |
       #   echo "TARGET_BRANCH=${{ github.event.workflow_run.pull_requests[0].base.ref }}" >> $GITHUB_ENV
        ##  BRANCH="${{ github.event.workflow_run.pull_requests[0].base.ref }}"
        #  echo "Target branch is $BRANCH"
       #   if [[ "$BRANCH" != "integra" && "$BRANCH" != "uat" && "$BRANCH" != "main" ]]; then
        #    echo "âŒ Deployment only allowed to integra, uat or main branches."
       #     exit 1
       #   fi
        
      - name: ğŸ“ Set Salesforce Environment Variables
        id: set_sf_env
        run: |
          BASE_REF="${GITHUB_BASE_REF:-${GITHUB_REF_NAME}}"
          echo "ğŸ” Branch destino: $BASE_REF"

          if [[ "$BASE_REF" == "INTEGRA" ]]; then
            echo "LOGIN_URL=https://test.salesforce.com" >> $GITHUB_ENV
            echo "CLIENT_ID=${{ secrets.SFDX_CLIENT_ID_INTEGRA }}" >> $GITHUB_ENV
            echo "USERNAME=${{ secrets.SFDX_USERNAME_INTEGRA }}" >> $GITHUB_ENV
            echo "JWT_KEY<<EOF" >> $GITHUB_ENV
            echo "JWT_KEY=${{ secrets.SFDX_JWT_KEY_INTEGRA }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          elif [[ "$BASE_REF" == "UAT" ]]; then
            echo "LOGIN_URL=https://test.salesforce.com" >> $GITHUB_ENV
            echo "CLIENT_ID=${{ secrets.SFDX_CLIENT_ID_UAT }}" >> $GITHUB_ENV
            echo "USERNAME=${{ secrets.SFDX_USERNAME_UAT }}" >> $GITHUB_ENV
            echo "JWT_KEY<<EOF" >> $GITHUB_ENV
            echo "JWT_KEY=${{ secrets.SFDX_JWT_KEY_UAT }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          elif [[ "$BASE_REF" == "MAIN" ]]; then
            echo "LOGIN_URL=https://login.salesforce.com" >> $GITHUB_ENV
            echo "CLIENT_ID=${{ secrets.SFDX_CLIENT_ID_PROD }}" >> $GITHUB_ENV
            echo "USERNAME=${{ secrets.SFDX_USERNAME_PROD }}" >> $GITHUB_ENV
            echo "JWT_KEY<<EOF" >> $GITHUB_ENV
            echo "JWT_KEY=${{ secrets.SFDX_JWT_KEY_PROD }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "âŒ Branch not supported"
            exit 1
          fi

      - name: Verificar existencia y tamaÃ±o del archivo JWT
        run: |
          echo "${{ env.JWT_KEY }}" > server.key
          if [ -f server.key ]; then
            echo "âœ… Archivo 'server.key' creado correctamente."
            ls -lh server.key
          else
            echo "âŒ No se encontrÃ³ el archivo 'server.key'."
            exit 1
          fi   

      - name: ğŸ”§ Instalar Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          
      - name: ğŸ§ª Verificar CLI instalada
        run: |
          echo "ğŸ” Verificando CLI instalada..."
          
          if command -v sf &> /dev/null; then
            echo "âœ… sf CLI instalada:"
            sf --version
          else
            echo "âŒ sf CLI NO estÃ¡ instalada."
          fi

          if command -v sfdx &> /dev/null; then
            echo "âœ… sfdx CLI instalada:"
            sfdx --version
          else
            echo "âŒ sfdx CLI NO estÃ¡ instalada."
          fi

      - name: ğŸ” Autenticarse en Salesforce con JWT
        env:
          SFDX_CLIENT_ID: ${{ env.CLIENT_ID }}
          SFDX_JWT_KEY: ${{ vars.SFDX_JWT_KEY_UAT }}
          SFDX_USERNAME: ${{ env.USERNAME }}
          SFDX_URL: ${{ env.LOGIN_URL }}
        run: |
          echo "$SFDX_JWT_KEY" > server.key
          sf org login jwt \
            --client-id "$SFDX_CLIENT_ID" \
            --jwt-key-file server.key \
            --username "$SFDX_USERNAME" \
            --instance-url "$SFDX_URL" \
            --alias SF

      - name: âœ Verify Authentication
        run: |
          sfdx force:org:list

      - name: ğŸ“‚ Mover Apex Classes y Triggers listados en package.xml
        run: |
          PACKAGE_XML="manifest/package.xml"
          DEST_DIR="pmd/classes"
          SRC_CLASSES_DIR="force-app/main/default/classes"
          SRC_TRIGGERS_DIR="force-app/main/default/triggers"

          mkdir -p "$DEST_DIR"

          echo "ğŸ” Analizando package.xml..."

          # Extraer ApexClass
          APEX_CLASSES=$(xmllint --xpath "//types[name='ApexClass']/members/text()" "$PACKAGE_XML" 2>/dev/null || true)

          # Extraer ApexTrigger
          APEX_TRIGGERS=$(xmllint --xpath "//types[name='ApexTrigger']/members/text()" "$PACKAGE_XML" 2>/dev/null || true)

          # Mover ApexClass
          if [ ! -z "$APEX_CLASSES" ]; then
            echo "ğŸ“š Clases Apex encontradas: $APEX_CLASSES"
            IFS=' ' read -r -a CLASS_ARRAY <<< "$APEX_CLASSES"
            for cls in "${CLASS_ARRAY[@]}"; do
              for ext in ".cls" "-meta.xml"; do
                FILE="$SRC_CLASSES_DIR/${cls}${ext}"
                [ -f "$FILE" ] && mv "$FILE" "$DEST_DIR/"
              done
            done
          fi

          # Mover ApexTriggers
          if [ ! -z "$APEX_TRIGGERS" ]; then
            echo "ğŸ§© Triggers encontrados: $APEX_TRIGGERS"
            IFS=' ' read -r -a TRIGGER_ARRAY <<< "$APEX_TRIGGERS"
            for trg in "${TRIGGER_ARRAY[@]}"; do
              for ext in ".trigger" "-meta.xml"; do
                FILE="$SRC_TRIGGERS_DIR/${trg}${ext}"
                [ -f "$FILE" ] && mv "$FILE" "$DEST_DIR/"
              done
            done
          fi

          echo "âœ… Archivos movidos a $DEST_DIR"


      - name: ğŸ“‚ Check if there are Test classes
        id: check_tests
        run: |
          if find ./pmd/classes -name '*.cls' | grep -q .; then
            echo "testfound=true" >> $GITHUB_ENV
          else
            echo "testfound=false" >> $GITHUB_ENV
          fi

      - name: ğŸ“„ Ver contenido de las reglas
        run: cat ./config/apex-ruleset.xml

      - name: ğŸ§° Install PMD
        if: env.testfound == 'true' && github.base_ref  == 'UAT' 
        run: |
          curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip pmd.zip -d pmd
          mv pmd/pmd-bin-6.55.0 pmd-bin
          chmod +x pmd-bin/bin/run.sh

      - name: ğŸ¤– Run Apex tests if it was found 
        if: env.testfound == 'true'
        run: |
          TEST_CLASSES=$(find ./pmd/classes -name "*Test.cls" -exec basename {} .cls \; | paste -sd, -)
          echo "ğŸ§ª Validating components with specific tests: $TEST_CLASSES...."
          sf deploy metadata validate \
            --manifest manifest/package.xml \
            --target-org SF \
            --test-level RunSpecifiedTests \
            --tests "$TEST_CLASSES" \
            --json || exit 1
            
      - name: â° Validate Salesforce components if no Apex tests was found
        if: env.testfound == 'false'
        run: |
         echo "ğŸ“­ No test classes found. Validating components without tests..."
         sf deploy metadata validate \
            --target-org SF \
            --manifest manifest/package.xml \
            --test-level RunLocalTests \
            --json || exit 1

            
